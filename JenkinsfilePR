pipeline {
    agent any
    
    environment {
       IMAGE = "ybenaoun/react-cicd-project"
       TAG="build-${env.BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
                steps {
                    echo "üîç Checkout PR"
                    checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                    echo "üì¶ Installing dependencies..."
                    bat '''
                        node --version
                        npm --version
                        npm ci
                    '''
            }
        }
        
        stage('Build') {
            steps {
                    echo "üî® Building React application..."
                    bat 'npm run build'
            }
        }
        
        stage('Docker Build') {
            steps {
                    echo "üê≥ Building Docker image..."
                    bat 'docker version'
                    bat "docker build -t %IMAGE%:%TAG% ."
            }
        }

        stage('Smoke Test') {
            steps {
                
                    echo "üß™ Running smoke tests..."
                    bat """
                        chmod +x scripts/smoke-test.sh
                        ./scripts/smoke-test.sh http://localhost:3000
                    """
                
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                
                    echo "üì¶ Archiving artifacts..."
                    bat """
                        mkdir -p artifacts/pr-${PR_NUMBER}
                        echo "PR #${PR_NUMBER} - Build ${BUILD_NUMBER}" > artifacts/pr-${PR_NUMBER}/build-info.txt
                        echo "Status: SUCCESS" >> artifacts/pr-${PR_NUMBER}/build-info.txt
                        echo "Branch: ${SOURCE_BRANCH}" >> artifacts/pr-${PR_NUMBER}/build-info.txt
                        echo "Date: \$(date)" >> artifacts/pr-${PR_NUMBER}/build-info.txt
                        
                        docker logs ${DOCKER_IMAGE} > artifacts/pr-${PR_NUMBER}/docker-logs.txt 2>&1 || true
                    """
                    archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
                
            }
        }
        
        stage('Cleanup') {
            steps {
                
                    echo "üßπ Cleaning up..."
                    bat """
                        docker stop ${DOCKER_IMAGE} || true
                        docker rm ${DOCKER_IMAGE} || true
                        docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true
                    """
                
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ PR Build & Smoke Test PASSED"
        }
        failure {
            echo "‚ùå PR Build & Smoke Test FAILED"
        }
        always {
            cleanWs()
        }
    }
}
