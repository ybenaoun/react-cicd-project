pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "react-app-pr-${env.BUILD_NUMBER}"
        DOCKER_TAG = "pr-${env.BUILD_NUMBER}"
        PORT = "3001"
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üîç Checkout PR from SCM"
                    checkout scm
                    
                    // Obtenir les informations de la PR depuis l'environnement Git
                    bat '''
                        git log -1 --pretty=format:"Commit: %%H%%nAuthor: %%an%%nDate: %%ad" > pr-info.txt
                        type pr-info.txt
                    '''
                }
            }
        }
        
        stage('Setup') {
            steps {
                script {
                    echo "üì¶ Installing dependencies..."
                    bat '''
                        node --version
                        npm --version
                        npm ci
                    '''
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    echo "üî® Building React application..."
                    bat 'npm run build'
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                script {
                    echo "üê≥ Building Docker image..."
                    bat """
                        docker build -t %DOCKER_IMAGE%:%DOCKER_TAG% -f Dockerfile.multistage .
                    """
                }
            }
        }
        
        stage('Run Container') {
            steps {
                script {
                    echo "üöÄ Starting Docker container..."
                    bat """
                        docker stop %DOCKER_IMAGE% 2>nul || echo Container not running
                        docker rm %DOCKER_IMAGE% 2>nul || echo Container not found
                        docker run -d --name %DOCKER_IMAGE% -p %PORT%:80 %DOCKER_IMAGE%:%DOCKER_TAG%
                        
                        echo Waiting for container to be ready...
                        timeout /t 10 /nobreak
                    """
                }
            }
        }
        
        stage('Smoke Test') {
            steps {
                script {
                    echo "üß™ Running smoke tests..."
                    bat '''
                        call scripts\\smoke-test.bat http://localhost:%PORT%
                    '''
                }
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                script {
                    echo "üì¶ Archiving artifacts..."
                    bat """
                        if not exist artifacts\\pr-%BUILD_NUMBER% mkdir artifacts\\pr-%BUILD_NUMBER%
                        
                        echo PR Build %BUILD_NUMBER% > artifacts\\pr-%BUILD_NUMBER%\\build-info.txt
                        echo Status: SUCCESS >> artifacts\\pr-%BUILD_NUMBER%\\build-info.txt
                        echo Date: %DATE% %TIME% >> artifacts\\pr-%BUILD_NUMBER%\\build-info.txt
                        
                        docker logs %DOCKER_IMAGE% > artifacts\\pr-%BUILD_NUMBER%\\docker-logs.txt 2>&1
                    """
                    archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "üßπ Cleaning up..."
                    bat """
                        docker stop %DOCKER_IMAGE% 2>nul || echo Already stopped
                        docker rm %DOCKER_IMAGE% 2>nul || echo Already removed
                        docker rmi %DOCKER_IMAGE%:%DOCKER_TAG% 2>nul || echo Image already removed
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ PR Build & Smoke Test PASSED"
        }
        failure {
            echo "‚ùå PR Build & Smoke Test FAILED"
        }
        always {
            cleanWs()
        }
    }
}
