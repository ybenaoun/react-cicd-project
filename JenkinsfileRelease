pipeline {
    agent any
    
    parameters {
        string(name: 'VERSION_TAG', defaultValue: '', description: 'Version Tag (e.g., v1.0.0)')
    }
    
    environment {
        DOCKER_IMAGE = "react-app"
        DOCKER_REGISTRY = "your-registry"
        VERSION = "${params.VERSION_TAG}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üîç Checkout tag ${VERSION}"
                    checkout scm
                    sh "git checkout tags/${VERSION}"
                }
            }
        }
        
        stage('Setup') {
            steps {
                script {
                    echo "üì¶ Installing dependencies for release..."
                    sh '''
                        node --version
                        npm --version
                        npm ci --only=production
                    '''
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    echo "üî® Building release version ${VERSION}..."
                    sh """
                        export REACT_APP_VERSION=${VERSION}
                        npm run build
                    """
                }
            }
        }
        
        stage('Docker Build & Tag') {
            steps {
                script {
                    echo "üê≥ Building and tagging Docker image..."
                    def versionNumber = VERSION.replaceAll('v', '')
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${versionNumber} \
                        -f Dockerfile.multistage .
                        
                        docker tag ${DOCKER_IMAGE}:${versionNumber} ${DOCKER_IMAGE}:latest
                        docker tag ${DOCKER_IMAGE}:${versionNumber} ${DOCKER_IMAGE}:stable
                    """
                }
            }
        }
        
        stage('Run Container') {
            steps {
                script {
                    echo "üöÄ Starting release container..."
                    sh """
                        docker stop ${DOCKER_IMAGE}-release || true
                        docker rm ${DOCKER_IMAGE}-release || true
                        docker run -d \
                        --name ${DOCKER_IMAGE}-release \
                        -p 3002:80 \
                        ${DOCKER_IMAGE}:${VERSION.replaceAll('v', '')}
                        
                        echo "Waiting for container to be ready..."
                        sleep 15
                    """
                }
            }
        }
        
        stage('Smoke Test') {
            steps {
                script {
                    echo "üß™ Running production smoke tests..."
                    sh """
                        chmod +x scripts/smoke-test.sh
                        ./scripts/smoke-test.sh http://localhost:3002
                        
                        chmod +x scripts/health-check.sh
                        ./scripts/health-check.sh http://localhost:3002
                    """
                }
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                script {
                    echo "üì¶ Archiving release artifacts..."
                    def versionNumber = VERSION.replaceAll('v', '')
                    sh """
                        mkdir -p artifacts/release-${versionNumber}
                        
                        echo "Release Version: ${VERSION}" > artifacts/release-${versionNumber}/release-info.txt
                        echo "Build Number: ${BUILD_NUMBER}" >> artifacts/release-${versionNumber}/release-info.txt
                        echo "Status: SUCCESS" >> artifacts/release-${versionNumber}/release-info.txt
                        echo "Date: \$(date)" >> artifacts/release-${versionNumber}/release-info.txt
                        echo "Commit: \$(git rev-parse HEAD)" >> artifacts/release-${versionNumber}/release-info.txt
                        
                        docker logs ${DOCKER_IMAGE}-release > artifacts/release-${versionNumber}/docker-logs.txt 2>&1 || true
                        
                        tar -czf artifacts/release-${versionNumber}/build-${versionNumber}.tar.gz build/
                        
                        docker save ${DOCKER_IMAGE}:${versionNumber} | gzip > artifacts/release-${versionNumber}/docker-image-${versionNumber}.tar.gz
                        
                        echo "${versionNumber}" > artifacts/release-${versionNumber}/VERSION.txt
                    """
                    archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                script {
                    echo "üì§ Pushing to Docker registry..."
                    def versionNumber = VERSION.replaceAll('v', '')
                    sh """
                        echo "Would push ${DOCKER_IMAGE}:${versionNumber} to registry"
                        # docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${versionNumber}
                        # docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    """
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "üßπ Cleaning up (keeping release container running)..."
                    sh """
                        docker image prune -f
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ Release Build ${VERSION} PASSED"
        }
        failure {
            echo "‚ùå Release Build ${VERSION} FAILED"
            sh "docker stop ${DOCKER_IMAGE}-release || true"
            sh "docker rm ${DOCKER_IMAGE}-release || true"
        }
        always {
            cleanWs()
        }
    }
}